
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Спастись на 8 марта</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <link rel="stylesheet" href="main.css">      
</head>
<body>

<script src="phrases.js"></script>

<audio loop id="audioMain">
    <source src="music/main_2.mp3" type="audio/mpeg">    
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioShoping">
    <source src="music/car.mp3" type="audio/mpeg">    
    Проигрывание музыки не поддерживается.
</audio>

<audio loop id="audioWin">
    <source src="music/win_audio.mp3" type="audio/mpeg">    
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioLoseJump">
    <source src="music/lose.mp3" type="audio/mpeg">        
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioLose">
    <source src="music/lose_audio.mp3" type="audio/mpeg">        
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioJumping">
    <source src="music/jump.mp3" type="audio/mpeg">        
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioCat">
    <source src="music/cat_myu.mp3" type="audio/mpeg">        
    Проигрывание музыки не поддерживается.
</audio>

<audio id="audioFish">
    <source src="music/fish_audio.mp3" type="audio/mpeg">        
    Проигрывание музыки не поддерживается.
</audio>

<!-- Блок для портретной ориентации -->
<div id="portrait-container" class="portrait-mode">
        
    <div id = "start-screen-id" class="start-screen">
        <div>        
            <div class="image-start-screen" style="margin-top: 350px;">            
                <img src="pic/game_title.png" alt="game_title_pic">
            </div>                       
            <div class="modal-footer" style="margin-top: 20px;">            
                <button id="show-rules" class="button-common button-common-327">Читать правила</button>      
            </div>       
            <div class="modal-footer" style="margin-top: 20px;">            
                <button id="start-game" class="button-common button-common-rules">Продолжить</button>      
            </div>
        </div>   
    </div>

    <div id = "rules-screen-id" class="rules-screen">
        <div>       
            <div class="rules-screen-body">            
                <div class="title_32_circe_extra_bold_brown_allcaps">Правила игры</div>                    
                <div>8 марта – это день, когда все должно быть идеально. Но семья думает иначе!</div>
                <div>
                <b>Твоя задача:</b> продержаться 1 минуту и не поддаться на бытовые провокации.<br>
                <b>Как играть:</b> Уворачивайся от домочадцев и их просьб, вовремя прыгая через них <br>
                <b>Твоя цель:</b> Сохранить спокойствие и время для себя.<br>
                <b>Помощь:</b> Если станет совсем тяжко – жми на кнопку «Уехать на шопинг», это даст тебе 5 секунд тишины.<br>
                <b>Приз:</b> Победишь – получишь заслуженный релакс и подарок от Суши Мастер!</div>
            </div>        
            <div class="modal-footer" style="margin-top: 20px;">            
                <button id="start-game2" class="button-common button-common-rules">Продолжить</button>      
            </div>
        </div>   
    </div>

    <div id="turn_screen_id" class="game-screen-turn-albom"> </div>

</div>
    
<!-- Блок для альбомной ориентации -->
<div id="landscape-container" class="landscape-mode hidden">   

    <div id="turn_screen_land_id" class="game-screen-turn-land">
        <div class="modal-footer" style="margin-top: 260px;">
            <!-- Эта кнопка будет показана только в альбомной ориентации -->
            <button id="continue-game" class="button-common button-common-rules">Старт</button>
        </div>
    </div>

    <div id="game_screen_id" class="game-screen">
        <div class="top_bar_conteiner">
            
            <div class="timer-body">
                <div class="timer-text" id="timer" style="margin-top: 10px;">0</div>
            </div>                                

            <div>
                <button id="music-icon" style="margin-right: 20px;" class="music-button">
                    <img id="music_pic_id" src="pic/sound_on.png" alt="turn_sound_pic">
                </button>
            </div>
        </div>

        <div id="game_area_id" class="game-area">
            <div id="enemy_id" class="enemy-conteiner">
                <img id="enemy_pic_id" src="pic/man.png" alt="enemy_pic">
                <p id="message-enemy-id" class="speech-bubble">Фраза</p>
            </div>
        
            <div id="hero_id" class="hero-conteiner">
                <img id="hero_image_id" src="pic/wife_stay.png" alt="hero_pic">
                <p id="message-hero-id" class="speech-bubble hidden">Фраза</p>
            </div>
        </div>
     
        <div class="bottom_bar_conteiner">
            <div style="margin-top: 50px; margin-left: 20px;">
                <button id="shopping_button_id" class="button-common button-common-280-red button-common-280-green">Поехать на шопинг</button>
            </div>
            <div>
                <button id="jump_button_id" class="jump-button">
                    <img src="pic/jump.png" alt="jump_pic">
                </button>
            </div>
        </div>
    </div>

    <div id="сongratulations-dialogue" class="game-screen game-screen-win">

        <div style="margin-right: 20px; margin-bottom: 20px;">               
            <div class="button-right">
                <div class="lose-screen-body win-screen-body">
                    <p> Всё получилось. Ты - настоящая супергероиня праздника!</p>
                </div>                
            </div>        
            
            <div class="button-right">            
                <button id="exit-game-win" class="button-common button-common-280-red button-common-280-green">Забрать промокод</button>            
            </div>
        </div> 
       
    </div>
    
    <div id="losegame" class="game-screen game-screen-lose">
        <div style="margin-right: 20px;">               
            <div class="button-right">
                <div class="lose-screen-body">
                    <p>Ой! Быт оказался коварней...Кажется, тебя затянул водоворот из носков, каши и кошачьего «мяу». Но не расстраивайся! Вдохни, выдохни и попробуй еще раз. Отдых уже близко! </p>
                </div>                
            </div>        
            
            <div class="button-right">            
                <button id="restart-game-lose" class="button-common button-common-280-red">Попробовать снова</button>            
            </div>
        </div>
    </div>

</div>


<script>


let timerInterval = null;
const SECONDS_FOR_ONE_GAME = 60;

document.addEventListener('DOMContentLoaded', () => {
    const portraitContainer = document.querySelector('#portrait-container');
    const landscapeContainer = document.querySelector('#landscape-container');

    // Функция для смены ориентации
    function handleOrientationChange() {
        if (window.matchMedia("(orientation: portrait)").matches) {
            portraitContainer.classList.remove('hidden');
            landscapeContainer.classList.add('hidden');
        } else {
            portraitContainer.classList.add('hidden');
            landscapeContainer.classList.remove('hidden');
        }
    }

    // Регистрация прослушивания изменений ориентации
    window.addEventListener('resize', handleOrientationChange);
});

document.getElementById('start-game').addEventListener('click', showTurnWarningScreen);
document.getElementById('start-game2').addEventListener('click', showTurnWarningScreen);
document.getElementById('continue-game').addEventListener('click', startGameScreen);
document.getElementById('show-rules').addEventListener('click', showRules);
document.getElementById('timer').textContent = SECONDS_FOR_ONE_GAME;


document.getElementById("restart-game-lose").addEventListener("click", function () {
    //тут нужно закрывать игру с призом NONE
    hideDialog()
    startGame()
});

    function showTurnWarningScreen() {
        document.getElementById("turn_screen_id").style.display = "block";
        document.getElementById("turn_screen_land_id").style.display = "block";
        
        document.getElementById('start-screen-id').style.display = "none";
        document.getElementById('rules-screen-id').style.display = "none";               
    }
       
    function startGameScreen() {
        document.getElementById("game_screen_id").style.display = "block";
        document.getElementById('start-screen-id').style.display = "none";
        document.getElementById("turn_screen_id").style.display = "none";
        document.getElementById("turn_screen_land_id").style.display = "none";        
        document.getElementById('rules-screen-id').style.display = "none";                        
        startGame()  
        
    }

    function showRules() {
        document.getElementById("rules-screen-id").style.display = "block";
        document.getElementById('start-screen-id').style.display = "none";     
                
    }    
    
    function resetTimerForNextQuestion() {        
        document.getElementById('timer').innerText = SECONDS_FOR_ONE_GAME;
        clearInterval(timerInterval);
        timerInterval = null
    }       
        
 
// Скрытие модального окна
    function hideDialog() {
    document.getElementById('сongratulations-dialogue').style.display = "none";    
    document.getElementById('losegame').style.display = "none";    
    document.getElementById("game_screen_id").style.display = "block";    
    }

</script>

<script>
    
    const gameScreen = document.getElementById("game_screen_id");
    const heroContainer = document.getElementById("hero_id");
    const enemyContainer = document.getElementById("enemy_id");
    const timerText = document.getElementById("timer");    
    const shoppingBtn = document.getElementById("shopping_button_id");
    const jumpBtn = document.getElementById("jump_button_id");
    const heroImage = document.querySelector('.hero-conteiner img');
    document.getElementById('music-icon').addEventListener('click', switchMusic);
    let heroImg = document.getElementById("hero_image_id");

    let isMusicPlay = true;
    let audioMain = document.getElementById("audioMain");
    let audioLose = document.getElementById("audioLose");
    let audioLoseJump = document.getElementById("audioLoseJump");
    let audioWin = document.getElementById("audioWin");
    let audioShoping = document.getElementById("audioShoping");
    let audioJumping = document.getElementById("audioJumping");

    let audioCat = document.getElementById("audioCat");
    let audioFish = document.getElementById("audioFish");
    
       

    let isJumping = false;    
    let isShoping = false;    
    
    let gameInterval;
    let newEnemy;    
    let timeout1;
    let timeout2;
    const accelerationFactor = 1.5;        
    let enemyCoordinate = 0;     
    
    // Персонажи с соответствующими фразами
    let personages = [
        {
            type: 'man',
            speed: 3,
            height: 161,
            image: 'pic/man.png',
            phrases: manPhrases,
            audioElement: null
        },
        {
            type: 'elderSon', // сохранено значение elderSon
            speed: 6,
            height: 175,
            image: 'pic/big_sun.png',
            phrases: teenBoyPhrases,
            audioElement: null
        },
        {
            type: 'youngerSon', // сохранено значение youngerSon
            speed: 7,
            height: 138,
            image: 'pic/little_sun.png',
            phrases: boyPhrases,
            audioElement: null
        },
        {
            type: 'daughter', // сохранено значение daughter
            speed: 5,
            height: 87,
            image: 'pic/daughter.png',
            phrases: girlPhrases,
            audioElement: null
        },
        {
            type: 'fish',
            speed: 8,
            height: 45,
            image: 'pic/fish.png',
            phrases: fishPhrases,
            audioElement: audioFish
        },
        {
            type: 'cat',
            speed: 10,
            height: 73,
            image: 'pic/cat.png',
            phrases: catPhrases,
            audioElement: audioCat
        }
    ];

    let currentPersonIndex = personages.findIndex(person => person.type === 'cat');
         
    // Начинаем игру
    function startGame() {        
        audioMain.volume = 0.2;
        audioWin.volume = 0.2;          
        resetGame();
        gameInterval = setInterval(updateGameState, 16); // Обновляем состояние игры каждые ~16 мс (~60FPS)        
        startTimer();
        if(isMusicPlay) {
            audioMain.play();     
        }
    }

    // Завершение игры
    function endGame() {        
        clearTimeout(timeout1);
        clearTimeout(timeout2);
        isInProcess = false;
        isShoping = false;
        clearInterval(gameInterval);
        stopTimer();      
        if(isMusicPlay) {
            audioMain.pause();
            audioLoseJump.play();
        }      
        showLoseScreen();        
    }

    function winGame () {
        clearInterval(gameInterval);
        stopTimer();
        showWinScreen();
    }

    function startTimer() {
        let timeLeft = SECONDS_FOR_ONE_GAME;                
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        document.getElementById('timer').innerText = timeLeft;                        
                    } else {
                        resetGame();
                        winGame();
                    }
                }, 1000);
            }            
    }

    function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null; 
    }

    let isChangingEnemy = false;

    // Основные игровые процессы
    function updateGameState() {   
                
        // Перемещение врага
        let increment = newEnemy.speed * accelerationFactor / 25 + 0.1;         
        enemyCoordinate += increment;
        enemyContainer.style.left = `${enemyCoordinate}%`;   
                
        // Проверка достижения конца экрана
        if (parseInt(enemyContainer.style.left.split("%")[0]) >= 90) {            
            changeEnemy(); // Заменяем врага на следующего
        }

        if (isJumping) {                                
            heroJump();                
        }
        if(isShoping == false) {
            checkCollision()
        }        
            
    }

    let isPlayingJumpSound = false; // Переменная для отслеживания текущего состояния звука    
    let startBottomPositionHero = 0;    
    
    function heroJump() {
        if (isJumping) {            
            playJumpAudio()
            startBottomPositionHero = heroContainer.style.bottom ? parseFloat(heroContainer.style.bottom) : 0;
            heroContainer.classList.add("hero-jumping"); // Включаем анимацию прыжка
            heroImg.src = "pic/wife_jump.png"; // Меняем картинку на прыжковую
            // Слушатель завершения анимации
            heroContainer.addEventListener("animationend", finishJump);
        }
    }

    function finishJump(event) {
        event.target.classList.remove("hero-jumping"); // Убираем класс анимации
        heroImg.src = "pic/wife_stay.png"; // Возвращаем исходную картинку
        isJumping = false; // Признак завершения прыжка
        isPlayingJumpSound = false;
    }

// Очищаем слушатели при выходе
    window.addEventListener("beforeunload", cleanupJumpListeners);

    function cleanupJumpListeners() {
        heroContainer.removeEventListener("animationend", finishJump);
    }

    function playJumpAudio() {
        if(isMusicPlay) { 
            if(isPlayingJumpSound==false){
                audioJumping.pause();
                audioJumping.currentTime = 0; 
            } 
            audioJumping.play();           
            isPlayingJumpSound = true;           
        }   
    }

    function getElementPosition(elementId) {
        return document.querySelector(`#${elementId}`).getBoundingClientRect();
    }

    let hasCollidedInCurrentJump = false; // Флаг для регистрации одиночного события столкновения

    function checkCollision() {
        const heroImageRect = getElementPosition('hero_image_id');
        const enemyImageRect = getElementPosition('enemy_pic_id');

        const heroX = heroImageRect.left + window.scrollX;
        const heroY = heroImageRect.top + window.scrollY;
        const enemyX = enemyImageRect.left + window.scrollX;
        const enemyY = enemyImageRect.top + window.scrollY;

        const contactWidth = 140;      // Допуск по горизонтали
        const jumpHigh = 100;          // Максимальная высота прыжка

        if (isJumping) {
            if (!hasCollidedInCurrentJump) {                
                if (heroY + jumpHigh > enemyY) {                    
                    hasCollidedInCurrentJump = true; // Устанавливаем флаг, предотвращая последующие обработки
                } else {                    
                    hasCollidedInCurrentJump = true; // Даже при столкновении ставим флаг, чтобы запретить дальнейшие проверки                                        
                    endGame();                    
                }
            }
        } else {
            // Возвращаем флаг в исходное состояние при завершении прыжка
            hasCollidedInCurrentJump = false;

            if (heroX <= enemyX + enemyImageRect.width && heroX + heroImageRect.width >= enemyX &&
                heroY <= enemyY + enemyImageRect.height && heroY + heroImageRect.height >= enemyY) {                
                endGame();               
            } 
        }
    }
    

    // Функция для отметки места столкновения
    function markCollisionPoint() {
        let collisionMarker = document.createElement('img');
        collisionMarker.src = 'pic/oops.png'; // Картинка для обозначения удара
        collisionMarker.style.position = 'absolute';
        collisionMarker.style.zIndex = '1000'; // Убедимся, что она поверх остальных элементов
        collisionMarker.style.left = `${enemyRect.x}px`;
        collisionMarker.style.top = `${enemyRect.y}px`;
        document.body.appendChild(collisionMarker);

        // Автоматически уберём маркер через короткое время
        setTimeout(() => {
            document.body.removeChild(collisionMarker);
        }, 1000); // Держим изображение 1 секунду
    }

        // Реакция на клик кнопки прыжка
        jumpBtn.onclick = () => {
            if (!isJumping) {
                isJumping = true;
            }
        };

        // Переход на шопинг
        shoppingBtn.onclick = () => {           
           goShoping()
        };
    
    let isInProcess = false;    

    function goShoping () {
            
        if (isInProcess || isShoping) return;

        isInProcess = true;
        isShoping = true;
        shoppingBtn.disabled = true;

        if(isMusicPlay) {
            audioMain.pause()          
            audioShoping.play() 
        }        
        const randomPhrase = goShopingPhrases[Math.floor(Math.random() * goShopingPhrases.length)];
        document.getElementById("message-hero-id").textContent = randomPhrase;    
        document.getElementById("message-hero-id").classList.remove("hidden");

        // Первый таймер для анимации
        timeout1 = setTimeout(() => {
            if (!isInProcess) return; // Проверка, завершился ли процесс
            heroContainer.classList.add("hide_herro_anination");
        }, 1000);

        // Второй таймер для возврата состояния
        timeout2 = setTimeout(() => {
            if (!isInProcess) return; // Проверка, завершился ли процесс
            document.getElementById("message-hero-id").classList.add("hidden");
            heroContainer.classList.remove("hide_herro_anination");
            if (isMusicPlay) {
                audioMain.play();
            }
            isShoping = false;
            isInProcess = false; // Завершаем операцию
        }, 4000);           
    }

    function changeEnemy() {

        if(isChangingEnemy) return;

        isChangingEnemy = true;

        currentPersonIndex = (currentPersonIndex + 1) % personages.length;
        newEnemy = personages[currentPersonIndex];
        document.getElementById("enemy_pic_id").src = newEnemy.image;    
        enemySpeed = newEnemy.speed;        
        const randomPhrase = newEnemy.phrases[Math.floor(Math.random() * newEnemy.phrases.length)];
        document.getElementById("message-enemy-id").textContent = randomPhrase;   
        
        enemyCoordinate = 0;
        enemyContainer.style.left = "0%";
          
        if(isMusicPlay && newEnemy.audioElement != null){
            newEnemy.audioElement.play()            
        }      
        isChangingEnemy = false;
        
    }

    function switchMusic() {
        if (isMusicPlay) {
            audioMain.pause();
            document.getElementById("music_pic_id").src = "pic/sound_off.png";        
            isMusicPlay = false;
        } else {
            audioMain.play();
            document.getElementById("music_pic_id").src = "pic/sound_on.png";                
            isMusicPlay = true;
        }    
    }  

        // Сброс состояния игры
        function resetGame() {    
            stopTimer();
            audioLose.pause();
            shoppingBtn.disabled = false;        
            isJumping = false;           
            enemyCoordinate = 0;
            heroBottomOffset = 0;            
            enemyContainer.style.left = "0%";
            changeEnemy()
        }
        
        function showWinScreen() {
            audioMain.pause();          
            setTimeout(() => {
            audioWin.play();  
            document.getElementById("game_screen_id").style.display = "none";
            document.getElementById("сongratulations-dialogue").style.display = "block";
            }, 1000)                
        }

        function showLoseScreen() {        
        audioMain.pause();
        if(isMusicPlay) {
            audioLose.play()
        }                  
        document.getElementById("game_screen_id").style.display = "none";
        document.getElementById("losegame").style.display = "block";        
        }

    </script>

<script>
    let tg = window.Telegram.WebApp; //получаем объект webapp телеграма 
    tg.expand(); //расширяем на все окно   
 

    document.getElementById('exit-game-win').addEventListener('click', function(){
      tg.sendData("1");      
    });       
    
 </script>
</body>
</html>